module processor(
	input clk,
	input reset,
	//these ports are used for serial IO and 
	//must be wired up to the data_memory module
	input[7:0] serial_in,
	input serial_valid_in,
	input serial_ready_in,
	output[7:0] serial_out,
	output serial_rden_out,
	output serial_wren_out
);
	// PC wires
	wire[31:0] pc_current;
	wire[31:0] pc_next;
	wire pc_load;

	// Instruction wires
	wire[31:0] instr;

	// Register file wires
	wire[4:0] rs, rt, rd;
	wire[31:0] reg_data1, reg_data2;
	wire[31:0] reg_write_data;
	wire reg_write_enable;

	// ALU wires
	wire[31:0] alu_a, alu_b;
	wire[31:0] alu_out;
	wire alu_branch, alu_jump;

	// Data memory wires
	wire[31:0] mem_read_data;
	wire[31:0] mem_write_data;
	wire mem_we, mem_re;
	wire[1:0]  mem_size;

	// Sign extension
	wire[31:0] imm_ext;
	
	// MUX wires
	wire [31:0] write_data_mux;
	wire [31:0] alu_b_mux;  
	wire [4:0] write_reg_mux;
	
	 
	// Instantiate PC Register
	pc_register PC (
		.clk(clk),
		.rst(reset),
		.pc_load(1'b1),
		.pc_in(pc_next),
		.pc_out(pc_current)
	);

	// Instantiate Adder
	adder ADD_PC (
		.a(pc_current),
		.b(32'd4),
		.sum(pc_next)
	);

	// Instantiate Instruction ROM
	inst_rom #(
		.ADDR_WIDTH(8),
		.INIT_PROGRAM("blank.memh")
	) ROM (
		.clock(clk),
		.reset(reset),
		.addr_in(pc_current),
		.data_out(instr)
	);

	// Distribute Instructions
	assign rs = instr[25:21];
	assign rt = instr[20:16];
	assign rd = instr[15:11];

	// Instantiate MUX for write_reg
	mux2 #(
		.WIDTH(5)
	) WRITE_REG_MUX (
		.a(rt),      // sel=0 -> use rt (bits 20:16)
		.b(rd),      // sel=1 -> use rd (bits 15:11)
		.sel(1'b0),  // dummy control signal 
		.y(write_reg_mux)
	);
	 
	// Instantiate Register File
	register RF (
		.clk(clk),
		.write_enable(reg_write_enable),
		.read_reg1(rs),
		.read_reg2(rt),
		.write_reg(write_reg_mux),
		.write_data(write_data_mux),
		.read_data1(reg_data1),
		.read_data2(reg_data2)
	);
	
	assign reg_write_enable = 1'b0; // Dummy Control signal for reg_write_enable
	 
	// Instantiate Sign Extend
	sign_extender SE (
		.in(instr[15:0]),
		.out(imm_ext)
	);
	 
	// Instantiate MUX for alu_b
	mux2 #(
		.WIDTH(32)
	) B_MUX (
		.a(reg_data2),   // sel=0 -> use reg_data2
		.b(imm_ext),     // sel=1 -> use imm_ext
		.sel(1'b0),      // dummy control signal 
		.y(alu_b_mux)
	);
	 
	// Instantiate ALU
	alu ALU (
		.Func_in(instr[31:26]),
		.A_in(reg_data1),
		.B_in(alu_b_mux),
		.O_out(alu_out),
		.Branch_out(alu_branch),
		.Jump_out(alu_jump)
	);
 
	// Instantiate Data Memory
	data_memory DM (
		.clock(clk),
		.reset(reset),

		.addr_in(alu_out),
		.writedata_in(reg_data2),
		.re_in(mem_re),
		.we_in(mem_we),
		.size_in(mem_size),
		.readdata_out(mem_read_data),

		.serial_in(serial_in),
		.serial_ready_in(serial_ready_in),
		.serial_valid_in(serial_valid_in),
		.serial_out(serial_out),
		.serial_rden_out(serial_rden_out),
		.serial_wren_out(serial_wren_out)
	);
 
	 assign mem_we = 1'b0;
    assign mem_re = 1'b0;
    assign mem_size = 2'b11;
	 
	// Instantiate MUX for write_data
	mux2 #(
		.WIDTH(32)
	) WRITE_DATA_MUX (
		.a(mem_read_data),  // sel=0 -> write memory data
		.b(alu_out),        // sel=1 -> write ALU result
		.sel(1'b0),         // dummy control signal 
		.y(write_data_mux)
	);

endmodule 